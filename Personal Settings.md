# Personal Settings and History Implementation Plan (English / ä¸­æ–‡)

This document contains the implementation plan in both English and Traditional Chinese.
è¿™ä»½æ–‡ä»¶åŒ…å«è‹±æ–‡ä¸ç¹ä½“ä¸­æ–‡ç‰ˆæœ¬çš„å®ä½œè®¡ç”»ã€‚

---

# ğŸ‡¬ğŸ‡§ Implementation Plan (English)

This plan outlines the steps to add a user profile settings page and a recommendation history feature to the Fashion Wardrobe app, including advanced preferences (Dislikes & Thermal Preference).

## User Review Required

> [!IMPORTANT]
> **Database Schema Changes Required**
> Since I cannot directly modify your Supabase schema, you will need to run the following SQL commands in your Supabase SQL Editor:
>
> ```sql
> -- 1. Add columns to users table (å€‹äººè³‡æ–™æ“´å……)
> ALTER TABLE users 
> ADD COLUMN IF NOT EXISTS gender text,             -- æ€§åˆ¥ (male/female)
> ADD COLUMN IF NOT EXISTS height text,             -- èº«é«˜ (cm)
> ADD COLUMN IF NOT EXISTS weight text,             -- é«”é‡ (kg)
> ADD COLUMN IF NOT EXISTS favorite_styles jsonb,   -- å–œå¥½é¢¨æ ¼ (Array)
> ADD COLUMN IF NOT EXISTS dislikes text,           -- é¿é›·æ¸…å–®
> ADD COLUMN IF NOT EXISTS thermal_preference text, -- é«”æ„Ÿåå¥½ (cold_sensitive/normal/heat_sensitive)
> ADD COLUMN IF NOT EXISTS custom_style_desc text;  -- è‡ªè¨‚æè¿°
>
> -- 2. Create recommendation_history table (æ­·å²ç´€éŒ„è¡¨)
> CREATE TABLE IF NOT EXISTS recommendation_history (
>     id bigint generated by default as identity primary key,
>     user_id uuid references users(id) not null,
>     city text,
>     occasion text,
>     style text,
>     recommendation_data jsonb,
>     created_at timestamp with time zone default timezone('utc'::text, now()) not null
> );
>
> -- 3. Enable RLS (å®‰å…¨æ€§æ¬Šé™è¨­å®š)
> ALTER TABLE recommendation_history ENABLE ROW LEVEL SECURITY;
>
> -- Policy: Users can only see their own history (åªèƒ½çœ‹è‡ªå·±çš„)
> CREATE POLICY "Users can view their own history" 
> ON recommendation_history FOR SELECT 
> USING (auth.uid() = user_id);
>
> -- Policy: Users can insert their own history (åªèƒ½å¯«å…¥è‡ªå·±çš„)
> CREATE POLICY "Users can insert their own history" 
> ON recommendation_history FOR INSERT 
> WITH CHECK (auth.uid() = user_id);
> ```

## Proposed Changes

### Backend

#### [NEW] [backend/api/user_service.py](file:///c:/Users/cmv52/OneDrive/%E6%A1%8C%E9%9D%A2/fashion/backend/api/user_service.py)
- Create `UserService` class to handle:
    - `get_profile(user_id)`
    - `update_profile(user_id, profile_data)`
    - `get_history(user_id)`
    - `save_history(user_id, recommendation_data)`

#### [MODIFY] [main.py](file:///c:/Users/cmv52/OneDrive/%E6%A1%8C%E9%9D%A2/fashion/main.py)
- Import and initialize `UserService`.
- Add endpoints:
    - `GET /api/profile`
    - `POST /api/profile`
    - `GET /api/history`
- Update `POST /api/recommendation` to call `user_service.save_history`.
- Update `POST /api/recommendation` to retrieve user profile and pass `dislikes` and `thermal_preference` to AI.

#### [MODIFY] [backend/database/models.py](file:///c:/Users/cmv52/OneDrive/%E6%A1%8C%E9%9D%A2/fashion/backend/database/models.py)
- Update `User` dataclass to include:
    - `height`, `weight`, `gender`
    - `favorite_styles` (JSON)
    - `dislikes` (Text, for blacklisted items/styles)
    - `thermal_preference` (Text: 'cold_sensitive', 'normal', 'heat_sensitive')
    - `custom_style_desc`

#### [MODIFY] [backend/api/ai_service.py](file:///c:/Users/cmv52/OneDrive/%E6%A1%8C%E9%9D%A2/fashion/backend/api/ai_service.py)
- Update `generate_outfit_recommendation` to accept user profile data.
- Modify the AI prompt to:
    - Respect `dislikes` (strictly avoid these).
    - Adjust warmth logic based on `thermal_preference` (e.g., if 'cold_sensitive', +1 warmth level).

### Frontend

#### [NEW] [frontend/profile.html](file:///c:/Users/cmv52/OneDrive/%E6%A1%8C%E9%9D%A2/fashion/frontend/profile.html)
- Create a new page for Personal Settings.
- **Sections**:
    1.  **Personal Info**: Gender (Male/Female), Height, Weight.
    2.  **Thermal Preference**: Radio buttons (Cold Sensitive / Normal / Heat Sensitive).
    3.  **Style Preferences**: Dropdown menu (Select style -> Show description -> Click 'Add').
    4.  **Dislikes**: Text input (e.g., "No shorts").
    5.  **Custom Description**: Textarea.
    6.  **History**: Scrollable list of past recommendations.

#### [NEW] [frontend/js/profile.js](file:///c:/Users/cmv52/OneDrive/%E6%A1%8C%E9%9D%A2/fashion/frontend/js/profile.js)
- Handle form loading/saving.
- **Style Selection Logic**: When a style is selected from the dropdown, display its detailed description immediately. Allow adding multiple styles via an "Add" button.
- Display history.

#### [MODIFY] [frontend/index.html](file:///c:/Users/cmv52/OneDrive/%E6%A1%8C%E9%9D%A2/fashion/frontend/index.html)
- Add "Personal Settings" button.

## Verification Plan

### Manual Verification
1.  **Database Setup**: Run updated SQL in Supabase.
2.  **Profile Data**:
    - Set Thermal Preference: "Cold Sensitive".
    - Select Style: "Japanese Cityboy" -> Verify description appears -> Add.
    - Set Dislikes: "Sandals".
    - Save.
3.  **AI Logic Check**:
    - Run recommendation in "Taipei" (e.g., 25Â°C).
    - "Cold Sensitive" user should see a light jacket/cardigan recommendation.
    - Verify no "Sandals" appear.

---

# ğŸ‡¹ğŸ‡¼ å¯¦ä½œè¨ˆç•« (ä¸­æ–‡)

æœ¬è¨ˆç•«æ¦‚è¿°å¦‚ä½•åœ¨æ™‚å°šè¡£æ«¥æ‡‰ç”¨ç¨‹å¼ä¸­æ–°å¢ã€Œä½¿ç”¨è€…å€‹äººè¨­å®šã€é é¢èˆ‡ã€Œæ¨è–¦æ­·å²ç´€éŒ„ã€åŠŸèƒ½ï¼ŒåŒ…å«é€²éšåå¥½è¨­å®šï¼ˆé¿é›·æ¸…å–®èˆ‡é«”æ„Ÿæº«åº¦åå¥½ï¼‰ã€‚

## éœ€è¦ä½¿ç”¨è€…å”åŠ©å¯©æŸ¥

> [!IMPORTANT]
> **éœ€è¦æ›´æ”¹è³‡æ–™åº«çµæ§‹**
> ç”±æ–¼æˆ‘ç„¡æ³•ç›´æ¥ä¿®æ”¹æ‚¨çš„ Supabase è³‡æ–™åº«ï¼Œè«‹æ‚¨åœ¨ Supabase SQL Editor ä¸­åŸ·è¡Œä»¥ä¸‹ SQL æŒ‡ä»¤ï¼š
>
> ```sql
> -- 1. åœ¨ users è¡¨æ ¼æ–°å¢æ¬„ä½
> ALTER TABLE users 
> ADD COLUMN IF NOT EXISTS height text, -- èº«é«˜
ADD COLUMN IF NOT EXISTS weight text, -- é«”é‡
ADD COLUMN IF NOT EXISTS gender text, -- æ€§åˆ¥
ADD COLUMN IF NOT EXISTS favorite_styles jsonb, -- å–œå¥½é¢¨æ ¼
> ADD COLUMN IF NOT EXISTS dislikes text, -- é¿é›·æ¸…å–® (A)
> ADD COLUMN IF NOT EXISTS thermal_preference text, -- é«”æ„Ÿæº«åº¦åå¥½ (B)
> ADD COLUMN IF NOT EXISTS custom_style_desc text; -- è‡ªè¨‚é¢¨æ ¼æè¿°
>
> -- 2. å»ºç«‹æ¨è–¦æ­·å²ç´€éŒ„è¡¨æ ¼
> CREATE TABLE IF NOT EXISTS recommendation_history (
>     id bigint generated by default as identity primary key,
>     user_id uuid references users(id) not null,
>     city text, -- åŸå¸‚
>     occasion text, -- å ´åˆ
>     style text, -- é¢¨æ ¼
>     recommendation_data jsonb, -- å®Œæ•´æ¨è–¦çµæœ
>     created_at timestamp with time zone default timezone('utc'::text, now()) not null
> );
> ```

## é è¨ˆä¿®æ”¹å…§å®¹ (Proposed Changes)

### å¾Œç«¯ (Backend)

#### [æ–°å¢] [backend/api/user_service.py](file:///c:/Users/cmv52/OneDrive/%E6%A1%8C%E9%9D%A2/fashion/backend/api/user_service.py)
- å»ºç«‹ `UserService` é¡åˆ¥ä¾†è™•ç†ï¼š
    - `get_profile(user_id)`ï¼šå–å¾—å€‹äººè³‡æ–™
    - `update_profile(user_id, profile_data)`ï¼šæ›´æ–°å€‹äººè³‡æ–™
    - `get_history(user_id)`ï¼šå–å¾—æ­·å²ç´€éŒ„
    - `save_history(user_id, recommendation_data)`ï¼šå„²å­˜æ­·å²ç´€éŒ„

#### [ä¿®æ”¹] [main.py](file:///c:/Users/cmv52/OneDrive/%E6%A1%8C%E9%9D%A2/fashion/main.py)
- åŒ¯å…¥ä¸¦åˆå§‹åŒ– `UserService`ã€‚
- æ–°å¢ APIè·¯å¾‘ï¼š
    - `GET /api/profile`
    - `POST /api/profile`
    - `GET /api/history`
- æ›´æ–° `POST /api/recommendation`ï¼š
    - åœ¨ç”Ÿæˆæ¨è–¦å¾Œï¼Œè‡ªå‹•å‘¼å« `user_service.save_history` å„²å­˜ç´€éŒ„ã€‚
    - åœ¨ç”Ÿæˆæ¨è–¦å‰ï¼Œå…ˆè®€å–ä½¿ç”¨è€…è³‡æ–™ï¼Œå°‡ `dislikes` (é¿é›·) å’Œ `thermal_preference` (å†·ç†±åå¥½) å‚³çµ¦ AIã€‚

#### [ä¿®æ”¹] [backend/database/models.py](file:///c:/Users/cmv52/OneDrive/%E6%A1%8C%E9%9D%A2/fashion/backend/database/models.py)
- æ›´æ–° `User` è³‡æ–™æ¨¡å‹ï¼Œæ–°å¢ï¼š
    - `height` (èº«é«˜), `weight` (é«”é‡), `gender` (æ€§åˆ¥)
    - `favorite_styles` (å–œå¥½é¢¨æ ¼æ¸…å–®)
    - `dislikes` (é¿é›·æ¸…å–®æ–‡å­—ï¼Œä¾‹å¦‚"ä¸ç©¿çŸ­è¤²")
    - `thermal_preference` (é«”æ„Ÿåå¥½ï¼šæ€•å†·/æ­£å¸¸/æ€•ç†±)
    - `custom_style_desc` (è‡ªè¨‚æè¿°)

#### [ä¿®æ”¹] [backend/api/ai_service.py](file:///c:/Users/cmv52/OneDrive/%E6%A1%8C%E9%9D%A2/fashion/backend/api/ai_service.py)
- æ›´æ–° `generate_outfit_recommendation` å‡½å¼ä»¥æ¥æ”¶ä½¿ç”¨è€…å€‹äººè³‡æ–™ã€‚
- ä¿®æ”¹ AI æç¤ºè© (Prompt)ï¼š
    - å¼·åˆ¶ AI éµå®ˆ `dislikes` (çµ•å°é¿é–‹é€™äº›å–®å“)ã€‚
    - æ ¹æ“š `thermal_preference` èª¿æ•´ä¿æš–é‚è¼¯ (ä¾‹å¦‚ï¼šè‹¥æ˜¯ã€Œæ€•å†·ã€ï¼Œè‡ªå‹•å¢åŠ ä¿æš–åº¦æ¬Šé‡)ã€‚

### å‰ç«¯ (Frontend)

#### [æ–°å¢] [frontend/profile.html](file:///c:/Users/cmv52/OneDrive/%E6%A1%8C%E9%9D%A2/fashion/frontend/profile.html)
- å»ºç«‹å…¨æ–°çš„ã€Œå€‹äººè¨­å®šã€é é¢ã€‚
- **å€å¡Šè¨­è¨ˆ**ï¼š
    1.  **å€‹äººè³‡è¨Š**ï¼šæ€§åˆ¥ (ç”·/å¥³)ã€èº«é«˜ã€é«”é‡è¼¸å…¥æ¡†ã€‚
    2.  **é«”æ„Ÿåå¥½**ï¼šå–®é¸æŒ‰éˆ• (æ€•å†· / æ­£å¸¸ / æ€•ç†±)ã€‚
    3.  **é¢¨æ ¼åå¥½ (æ›´æ–°)**ï¼šä½¿ç”¨ **ä¸‹æ‹‰å¼é¸å–®**ã€‚ç•¶ä½¿ç”¨è€…é¸å–æŸå€‹é¢¨æ ¼æ™‚ï¼Œä¸‹æ–¹æœƒé¡¯ç¤ºè©²é¢¨æ ¼çš„**è©³ç´°æ–‡å­—æ•˜è¿°**ã€‚æä¾›ã€Œæ–°å¢ã€æŒ‰éˆ•è®“ä½¿ç”¨è€…å°‡å…¶åŠ å…¥å–œå¥½æ¸…å–®ï¼ˆæ”¯æ´è¤‡é¸ï¼‰ã€‚
    4.  **é¿é›·å°ˆå€ (Dislikes)**ï¼šæ–‡å­—è¼¸å…¥æ¡† (ä¾‹å¦‚ï¼š"ä¸å–œæ­¡æ¶¼é‹")ã€‚
    5.  **è‡ªè¨‚æè¿°**ï¼šå¤šè¡Œæ–‡å­—è¼¸å…¥æ¡†ã€‚
    6.  **æ­·å²ç´€éŒ„**ï¼šå¯æ²å‹•çš„åˆ—è¡¨ï¼Œé¡¯ç¤ºéå»çš„æ¨è–¦çµæœã€‚

#### [æ–°å¢] [frontend/js/profile.js](file:///c:/Users/cmv52/OneDrive/%E6%A1%8C%E9%9D%A2/fashion/frontend/js/profile.js)
- è™•ç†è¡¨å–®è¼‰å…¥ (Fetch) èˆ‡å­˜æª” (Save)ã€‚
- **é¢¨æ ¼é¸æ“‡é‚è¼¯ (æ›´æ–°)**ï¼šç›£è½ä¸‹æ‹‰é¸å–®è®ŠåŒ–ï¼Œå³æ™‚é¡¯ç¤ºå°æ‡‰çš„é¢¨æ ¼æè¿°ã€‚
- é¡¯ç¤ºæ­·å²ç´€éŒ„åˆ—è¡¨ã€‚

#### [ä¿®æ”¹] [frontend/index.html](file:///c:/Users/cmv52/OneDrive/%E6%A1%8C%E9%9D%A2/fashion/frontend/index.html)
- åœ¨å°è¦½åˆ—æ–°å¢ã€Œå€‹äººè¨­å®šã€æŒ‰éˆ•ã€‚

## é©—è­‰è¨ˆç•« (Verification Plan)

### æ‰‹å‹•é©—è­‰
1.  **è³‡æ–™åº«è¨­å®š**ï¼šåœ¨ Supabase åŸ·è¡Œæ›´æ–°çš„ SQL æŒ‡ä»¤ã€‚
2.  **æ¸¬è©¦å€‹äººè³‡æ–™**ï¼š
    - è¨­å®šé«”æ„Ÿåå¥½ç‚ºï¼šã€Œæ€•å†· (Cold Sensitive)ã€ã€‚
    - **æ¸¬è©¦é¢¨æ ¼é¸å–®**ï¼š
        - é»é¸ä¸‹æ‹‰é¸å–®é¸æ“‡ã€Œæ—¥ç³» (Japanese Cityboy)ã€ã€‚
        - ç¢ºèªä¸‹æ–¹å‡ºç¾ã€Œç‰ˆå‹å¯¬é¬† (Oversized)...ã€ç­‰æè¿°æ–‡å­—ã€‚
        - é»é¸ã€Œæ–°å¢ã€ï¼Œç¢ºèªé¢¨æ ¼é€²å…¥ä¸‹æ–¹æ¸…å–®ã€‚
    - è¨­å®šé¿é›·æ¸…å–®ç‚ºï¼šã€Œæ¶¼é‹ã€ã€‚
    - é»æ“Šå„²å­˜ã€‚
3.  **æ¸¬è©¦ AI é‚è¼¯**ï¼š
    - å›é¦–é ç”Ÿæˆæ¨è–¦ (å‡è¨­å°åŒ— 25åº¦)ã€‚
    - é æœŸçµæœï¼šã€Œæ€•å†·ã€çš„ä½¿ç”¨è€…æ‡‰è©²æœƒçœ‹åˆ° AI å»ºè­°åŠ ä»¶è–„å¤–å¥—æˆ–é‡ç¹”è¡«ã€‚
    - é æœŸçµæœï¼šå³ä½¿è¡£æ«ƒæœ‰æ¶¼é‹ï¼ŒAI ä¹Ÿä¸æ‡‰è©²æ¨è–¦æ¶¼é‹ã€‚
